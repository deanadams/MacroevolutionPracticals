---
title: "Discrete Trait Phylogenetic Association"
author: "Dean Adams (dcadams@iastate.edu)"
date: "`r Sys.Date()`"
output: 
  html_document:
    css: ../../Instructor_Materials/style/styles.css
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../") })
---



```{r,echo=F}

knitr::read_chunk('PhyloAssocDiscrete.R')

```


### **Overview**
This tutorial is intended to describe how we investigate correlated trait evolution, through methods that examine trait associations between discrete traits. Conceptually, the challenge is to identify associated shifts in two discrete traits while accounting for phylogenetic non-independence (i.e., conditioning the data on the phylogeny). For trait associations between discrete changes, we use likelihood or Bayesian approaches. **NOTE: much of this tutorial follows the Supplemental tutorial from Chapter 7 in Revell and Harmon (Phylogenetic Comparative Methods in R).** 

### Learning Objectives

* Be able to set up an 'equal rates' and 'all rates different' rate matrices for single and multiple traits
* Know how to alter the initial rate matrices for creating alternate hypotheses
* Fit models and interpret results in terms of the biological question 
* Compare the fit of various models using AIC or log likelihoods

### Download data files
To run the analyses in this tutorial, we will need several files Chapter 7 of Revell and Harmon, 2022 (Phylogenetic Comparative Methods in R). Please download them from our Git-course repository: 

[BonyFish Phylogeny](https://github.com/deanadams/MacroevolutionPracticals/blob/main/09-Phylo_Assoc_Discrete/data/bonyfish.tre)

[BonyFish Data](https://github.com/deanadams/MacroevolutionPracticals/blob/main/09-Phylo_Assoc_Discrete/data/bonyfish.csv)

Additionally, The R-script for running the code found in this tutorial is found here:

[RScript](https://github.com/deanadams/MacroevolutionPracticals/blob/main/09-Phylo_Assoc_Discrete/scripts/PhyloAssocDiscrete.r)

As before, on your local computer, place them in a folder named 'TutorialData', which is found in the same directory as this tutorial. 

#### **Conceptual Background**
In macroevolutionary studies, we are often interested in determining how two or more traits covary across a set of taxa. We are particularly interested in determining whether traits covary even when we account for the phylogenetic relationships among species. Sometimes the traits we are interested have discrete character states: 'aposematic' versus 'cryptic' for example. We may then wish to know whether the characters states between two such traits are evolutionarily associated. 

### **Bringing Data into R**

<div class = "try">
### Reading in the Data

Before we perform our comparative analysis we must read in our data and our phylogeny into R, and 'link' them up by pruning them relative to one another so that all taxa in the tree are found in the data matrix and vice versa. Recall that for this to work properly, the rownames of our data matrix (or 'names' of a vector if a single variable) must match the names of the taxa at the tips of the phylogeny. These are found as: `phy$tip.label`. It may be helpful to view previous tutorials if you need help reading in and matching data.

1. Load the `geiger`, `phytools`, and `corHMM` package with `library()`.
2. Use `read.tree()` to read in the tree titled `bonyfish.tre`. 
3. Use the `read.csv()` function to read in the discrete trait data called `bonyfish.csv`.

</div>
<br></br>

```{r,read_data, eval=T,echo=F,results='hide'}
```

### Plotting the BonyFish Data

Now let's plot the data. Briefly, this is a subset of the data from Benun Sutton and Wilson (2019) in which spawning mode (group or pairs) and paternal care (male or none) were recorded. The authors hypothesized that male parental care would be observed in high frequency with pair spawning, as in this case males would have greater confidence that they sired the offspring. We will test this hypothesis below. 

```{r,plot_bonyfish_data,eval=TRUE}
```


### Test of Evolutionary Association

To determine whether there is an evolutionary association between spawning mode and paternal care, we will perform a likelihood ratio test that compares two alternative hypotheses: 1) the evolution of the two traits is independent, versus 2) the evolution of the traits depends upon one another. If the second model is preferred, then there is evidence that spawning mode and paternal care are evolutionarily associated. Here we will perform this test using the `fitPagel` function in `phytools`. Note that one can specify whether to use an equal rates model or an all rates different model (see help file).

```{r,Association_Test,eval=T}
```

As we can see statistically and visually, spawning mode and paternal care are evolutionarily associated with one another. More specifically, there are strong evolutionary shifts away from male+group character states towards both the male+pair and none+group states. That means an associated shift towards male parental care associated with paired spawning, as well as no paternal care associated with group spawning. Thus with this example, the prediction is upheld! 

#### Directional tests

The above test evaluated evidence relative to two hypotheses: 1) our traits evolve independently, and 2) our traits evolution in an associated manner.  Technically there are two additional possibilities: that spawning mode *depends* on paternal care state, and that paternal care state *depends* on spawning mode state. These two dependent models result in differing patterns of evolution, and describe the evolution of one trait only *AFTER* a particular character state has evolved in a second trait.  Here we test these models: 

```{r,Directional_Tests,eval=T}
```

As we can see, the two dependent models have higher support than the fully independent model, and in fact a model where parental care depends on spawning mode is slightly preferred, but this is not more informative than the overall dependency model tested previously (based on LRT and AIC). 

#### Other Implementations

In the examples above we used the `fitPagel` function in `phytools`. Other approaches use a "hidden rates" model to evaluate trait associations. These may be implemented in the `fitHRM` function in `phytools`. Additionally, the most current version of hidden rates models may be found in the `corHMM` package, which is considered the gold standard for such tests. See the help file of this package and associated theory papers in the literature if interested in implementing these approaches. 
